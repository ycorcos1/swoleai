# MEMO.md ‚Äî SwoleAI (Decisions + Notes)

## A) Locked Product Decisions
- App name: **SwoleAI**
- UI theme: **PulsePlan** (dark-first glass, purple‚Üíblue accents)
- Must-have features included:
  - Accounts + multi-device sync
  - Offline-first workout logging
  - Workout usability: edit/undo/continue/reorder/add exercise/set flags
  - Rest timer QoL
  - Splits + saved workout days (fixed + slot-based)
  - Favorites bank + ‚ÄúGenerate Day from Favorites‚Äù
  - Deterministic substitutions
  - Muscle-group volume targets + balance warnings
  - Robust PR system
  - User-selectable progression engines
  - Program blocks + routine versioning + rollback
  - Deload + recovery management
  - AI coach proposals: Next Session Plan, Weekly Check-in, Goals/Guardrails, Plateau interventions
  - Data features: export/import, download data, delete account/data

## B) Implementation Locks
- Hosting: Vercel
- DB: Neon Postgres
- ORM: Prisma
- Auth: Auth.js (NextAuth)
- AI: OpenAI API (server-side)
- Offline: IndexedDB (Dexie) + service worker caching
- Validation: Zod

## C) UX Rules (non-negotiable)
- AI never silently applies changes.
- Weekly check-in proposes **small patches**, not full rewrites.
- Accepting patches creates a new routine version (with changelog) inside a program block.
- Workout Mode must remain usable without network.

## D) MVP vs V1 Reminder
- MVP ships the end-to-end loop: auth ‚Üí split/day template ‚Üí workout mode (offline) ‚Üí summary ‚Üí next session plan + basic weekly check-in.
- V1 completes: full blocks/version compare/rollback UI, full volume dashboard, plateau interventions, advanced progression engines.

## E) Known Risk Areas
- iOS PWA quirks (service worker caching, storage limits, notification limitations)
- Auth session persistence and middleware edge cases
- Sync conflicts if user edits sessions across devices
- AI JSON validation and fallback behavior

## F) Next Docs To Create
- TASK_LIST.md (last)
- ERROR_FIX_LOG.md (optional)

---

## G) Implementation Progress

### Task 0.1 ‚Äî Add `.env.example` ‚úÖ
- `.env.example` created with all required env vars from TECH_STACK.md
- `.gitignore` added to ensure `.env` (secrets) is never committed
- Git repo initialized

### Task 0.2 ‚Äî Add base dependencies (frontend + backend) ‚úÖ
- Next.js 16.1.6 + TypeScript + App Router initialized with `src/` directory
- Tailwind CSS v4 with `@tailwindcss/postcss` plugin
- Prisma + `@prisma/client` for ORM
- NextAuth (next-auth) for authentication
- Zod for validation
- TanStack Query (`@tanstack/react-query`) for server state
- Dexie + `dexie-react-hooks` for IndexedDB offline persistence
- Lucide (`lucide-react`) for icons
- `@ducanh2912/next-pwa` for PWA/service worker support
- Added scripts: `dev`, `build`, `start`, `lint`, `db:generate`, `db:push`, `db:migrate`, `db:studio`
- Note: Used `process.cwd()` for `turbopack.root` in `next.config.ts` to avoid conflicts with parent directory `package.json`

### Task 0.3 ‚Äî Create App Shell layout (PulsePlan baseline) ‚úÖ
- Created `src/app/globals.css` with full PulsePlan design system:
  - Dark-first color palette (base-900 through base-500, text colors)
  - Purple‚Üíblue gradient accent (`--color-accent-gradient`)
  - Glass card utility (`.glass-card` with backdrop blur)
  - Primary/secondary button styles with gradient glow
  - Status pill variants (success/warning/error/info)
  - CSS custom properties for spacing, radii, shadows
  - Safe-area padding for PWA (notch/home indicator)
  - Tabular numerals for weights/reps
- Created `AppShell` component (`src/components/layout/AppShell.tsx`) as main authenticated layout wrapper
- Created `BottomNav` component (`src/components/layout/BottomNav.tsx`) with 5 nav items:
  - Dashboard, Workout, Routine, Insights, Settings
  - Active state highlighting using pathname matching
  - Lucide icons, touch-friendly sizing
- Created nested `/app` route layout (`src/app/app/layout.tsx`) wrapping children in AppShell
- Created `/app/dashboard` page with glass cards for Today, Coach Actions, Quick Stats
- Created reusable `GlassCard` UI component
- Updated root layout with SwoleAI metadata and dark theme viewport config

### Task 1.1 ‚Äî Create public pages: Homepage ‚úÖ
- Rebuilt `src/app/page.tsx` as SwoleAI homepage (replacing Next.js boilerplate)
- Hero section with gradient logo icon (Dumbbell), "SwoleAI" branding, tagline
- CTA buttons: "Create account" (primary, links to `/signup`), "Log in" (secondary, links to `/login`)
- 3 feature tiles using `GlassCard` styling: Log fast, AI coach proposals, Versioned routines
- Footer with Privacy/Terms links
- Background decorations with blurred gradient circles for atmosphere
- Mobile-first design following PulsePlan spec

### Task 1.2 ‚Äî Create public pages: Login ‚úÖ
- Created `src/app/login/page.tsx` with full login UI
- Email field with icon, placeholder, and validation
- Password field with show/hide toggle button
- Client-side validation: required checks, email format regex, minimum 6 character password
- Real-time validation on blur + form submit validation
- Inline error display with red border, AlertCircle icon, and error message
- Forgot password link pointing to `/forgot-password`
- "Create account" link at bottom pointing to `/signup`
- Loading state with spinner during form submission
- PulsePlan styling: dark theme, glass background effects, gradient logo

### Task 1.3 ‚Äî Create public pages: Signup ‚úÖ
- Created `src/app/signup/page.tsx` with full signup UI
- Email field with icon, placeholder, and validation (required + email format regex)
- Password field with show/hide toggle button
- Confirm password field with show/hide toggle button
- Client-side validation: email (required + valid format), password (required, min 8 chars, uppercase, lowercase, number), confirm password (required + must match)
- Real-time validation on blur + form submit validation
- Inline error display with red border, AlertCircle icon, and error message
- Password strength indicators showing requirements progress (checkmarks for met criteria)
- "Log in" link at bottom pointing to `/login`
- Loading state with spinner during form submission
- PulsePlan styling: dark theme, glass background effects, gradient logo matching login page

### Task 1.4 ‚Äî Create public pages: Forgot Password (UI only) ‚úÖ
- Created `src/app/forgot-password/page.tsx` with password reset request UI
- Email field with icon, placeholder, and client-side validation (required + email format regex)
- Real-time validation on blur + form submit validation
- Inline error display with red border, AlertCircle icon, and error message
- Loading state with spinner during form submission
- Success state after submission showing "Check your email" confirmation with submitted email displayed
- "Try again" button in success state to allow re-submitting
- "Back to login" links in header and footer
- "Remember your password? Log in" link at bottom
- PulsePlan styling: dark theme, glass background effects, gradient logo matching login/signup pages
- Build verified: `/forgot-password` route included in static pages output

### Task 1.5 ‚Äî Configure Auth.js/NextAuth (server) ‚úÖ
- Created `src/lib/auth/auth.config.ts` with full NextAuth configuration:
  - Credentials provider for email/password authentication
  - Zod schema validation for credentials
  - bcrypt password hashing (12 rounds)
  - JWT session strategy with 30-day maxAge
  - Custom callbacks for session/token handling with user id/email
  - Custom pages config pointing to `/login`, `/signup`
- Created `src/app/api/auth/[...nextauth]/route.ts` route handler
- Created `src/app/api/auth/signup/route.ts` for user registration:
  - Zod validation (email format, password min 8 chars + uppercase + lowercase + number)
  - Duplicate email check (409 conflict response)
  - Password hashing with bcrypt before storage
  - Returns 201 with user id/email on success
- Created `src/types/next-auth.d.ts` extending Session and JWT types with `id` and `email`
- Created `src/components/providers/AuthProvider.tsx` wrapping app with `SessionProvider`
- Updated `src/app/layout.tsx` to wrap children with `<AuthProvider>`
- Updated `src/app/login/page.tsx`:
  - Wired form to `signIn('credentials')` from next-auth/react
  - Redirects to `/app/dashboard` on success
  - Shows general error banner for invalid credentials
- Updated `src/app/signup/page.tsx`:
  - Calls `/api/auth/signup` to create account
  - Auto signs in after successful signup
  - Redirects to `/app/dashboard` on success
  - Shows email-specific error for duplicate account (409)
- Added `bcryptjs` + `@types/bcryptjs` dependencies
- Note: In-memory user store used for development; will be replaced with Prisma DB in Task 2.x
- Build verified: all routes compile, TypeScript passes, lint clean

### Task 1.6 ‚Äî Add auth middleware to protect `/app/*` ‚úÖ
- Created `src/middleware.ts` with route protection for `/app/*` paths
- Uses `getToken` from `next-auth/jwt` to check for valid session token
- Unauthenticated users redirected to `/login` with `callbackUrl` query param preserved
- Middleware matcher configured for `/app/:path*` pattern only
- Build verified: middleware registered as "∆í Proxy (Middleware)" in Next.js build output
- TypeScript passes, ESLint clean
- Note: Next.js 16 shows deprecation warning for "middleware" in favor of "proxy" convention, but middleware still functions correctly

### Task 2.1 ‚Äî Initialize Prisma + connect to Neon ‚úÖ
- Created `prisma/schema.prisma` with PostgreSQL datasource pointing to `DATABASE_URL` env var
- Configured generator for `prisma-client-js`
- Added minimal `User` model (id, email, createdAt, updatedAt) to verify connection
- Model uses `@@map("users")` for snake_case table naming
- Created `src/lib/db/prisma.ts` with Prisma client singleton pattern (prevents hot-reload connection exhaustion)
- Created `src/lib/db/index.ts` barrel export for convenient imports
- Ran `prisma migrate dev --name init` ‚Üí migration applied successfully to Neon Postgres
- Migration file: `prisma/migrations/20260218000328_init/migration.sql`
- Verified: `prisma migrate status` shows "Database schema is up to date!"
- Note: Full User model fields (profile, constraints, etc.) will be added in Task 2.2

### Task 2.2 ‚Äî Add core tables: users + profile fields ‚úÖ
- Extended `User` model in `prisma/schema.prisma` with profile fields from PRD 8.2 (Onboarding Wizard):
  - `goalMode` (enum: HYPERTROPHY, STRENGTH, HYBRID)
  - `daysPerWeek` (Int, nullable)
  - `sessionMinutes` (Int, nullable)
  - `units` (enum: METRIC, IMPERIAL, default IMPERIAL)
  - `equipment` (enum: COMMERCIAL, HOME, default COMMERCIAL)
  - `constraints` (Json, default `{}` ‚Äî structure: injuries, avoidExercises, mustHaveExercises arrays)
  - `onboardingComplete` (Boolean, default false)
  - `password` (String, nullable ‚Äî for credentials auth)
- Created three Prisma enums: `GoalMode`, `UnitSystem`, `EquipmentAccess`
- Migration file: `prisma/migrations/20260218000528_add_user_profile_fields/migration.sql`
- Ran `prisma migrate dev --name add_user_profile_fields` ‚Üí migration applied successfully
- Verified: `prisma db pull --print` confirms all profile fields exist in Neon DB
- Verified: `tsc --noEmit` passes with no errors

### Task 2.3 ‚Äî Add exercises + favorites schema ‚úÖ
- Added `Exercise` model in `prisma/schema.prisma` with all required tags:
  - `name` (String)
  - `type` (enum: BARBELL, DUMBBELL, MACHINE, CABLE, BODYWEIGHT, OTHER)
  - `pattern` (enum: HORIZONTAL_PUSH, HORIZONTAL_PULL, VERTICAL_PUSH, VERTICAL_PULL, HIP_HINGE, SQUAT, LUNGE, ISOLATION, CARRY, CORE, OTHER)
  - `muscleGroups` (Json, default `[]` ‚Äî array of muscle group strings)
  - `equipmentTags` (Json, default `[]` ‚Äî array of equipment strings)
  - `jointStressFlags` (Json, default `{}` ‚Äî object mapping joint to stress level)
  - `isCustom` (Boolean, default false) + `ownerUserId` (nullable) for user-created exercises
- Added `Favorite` model linking users to exercises:
  - `userId` + `exerciseId` with `@@unique` constraint for idempotent favorites
  - `priority` (enum: PRIMARY, BACKUP) for slot-filling preference
  - `tags` (Json, default `[]`) for organization
- Created three new enums: `ExerciseType`, `MovementPattern`, `FavoritePriority`
- Added relations: User ‚Üí exercises (custom), User ‚Üí favorites, Exercise ‚Üí favorites
- Added indexes for efficient queries: `[ownerUserId, isCustom]` on exercises, `[userId]` on favorites
- Migration file: `prisma/migrations/20260218000710_add_exercises_and_favorites/migration.sql`
- Ran `prisma migrate dev --name add_exercises_and_favorites` ‚Üí migration applied successfully
- Verified: Migration SQL includes `CREATE UNIQUE INDEX "favorites_user_id_exercise_id_key"` enforcing unique constraint
- Verified: `tsc --noEmit` passes with no errors

### Task 2.4 ‚Äî Add splits + split schedule schema ‚úÖ
- Added `Split` model in `prisma/schema.prisma` representing workout program schedules:
  - `name` (String ‚Äî e.g., "PPL 6-Day", "Upper/Lower")
  - `isActive` (Boolean, default false) ‚Äî drives Dashboard "Today" workout suggestion
  - `userId` + `user` relation (cascade delete)
  - `scheduleDays` relation to `SplitScheduleDay`
- Added `SplitScheduleDay` model mapping weekdays to templates or rest:
  - `splitId` + `split` relation (cascade delete)
  - `weekday` (enum: SUNDAY through SATURDAY)
  - `workoutDayTemplateId` (nullable String ‚Äî will link to Task 2.5 WorkoutDayTemplate)
  - `isRest` (Boolean, default false)
  - `label` (nullable String ‚Äî e.g., "Push A", "Legs")
  - `@@unique([splitId, weekday])` ‚Äî each split can only have one entry per weekday
- Created `Weekday` enum: SUNDAY, MONDAY, TUESDAY, WEDNESDAY, THURSDAY, FRIDAY, SATURDAY
- Added `splits` relation on User model
- Added indexes: `[userId]` and `[userId, isActive]` on splits, `[splitId]` on split_schedule_days
- Migration file: `prisma/migrations/20260218000906_add_splits_and_schedule/migration.sql`
- Ran `prisma migrate dev --name add_splits_and_schedule` ‚Üí migration applied successfully
- One active split per user: enforced at app level (deactivate all other splits before activating new one)
- Verified: `prisma migrate status` shows "Database schema is up to date!"
- Verified: `tsc --noEmit` passes with no errors

### Task 2.5 ‚Äî Add day templates schema (fixed + slot) ‚úÖ
- Added `WorkoutDayTemplate` model in `prisma/schema.prisma` representing saved workout day configurations:
  - `name` (String ‚Äî e.g., "Push A", "Full Body")
  - `mode` (enum: FIXED, SLOT) ‚Äî determines how exercises are defined
  - `defaultProgressionEngine` (enum: DOUBLE_PROGRESSION, STRAIGHT_SETS, TOP_SET_BACKOFF, RPE_BASED, NONE)
  - `notes` (nullable String), `estimatedMinutes` (nullable Int)
  - `userId` + `user` relation (cascade delete)
  - `blocks` relation (for FIXED mode), `slots` relation (for SLOT mode), `scheduleDays` relation
- Added `WorkoutDayBlock` model for FIXED template mode (explicit exercises):
  - `templateId` + `template` relation (cascade delete)
  - `orderIndex` (Int) with `@@unique([templateId, orderIndex])`
  - `exerciseId` + `exercise` relation (onDelete: Restrict)
  - `setsPlanned` (default 3), `repMin` (default 8), `repMax` (default 12), `restSeconds` (default 120)
  - `progressionEngine` (nullable ‚Äî override template default)
  - `intensityTarget` (Json ‚Äî {rpe?, rir?, percentOf1RM?}), `notes` (nullable)
- Added `WorkoutDaySlot` model for SLOT template mode (muscle group placeholders):
  - `templateId` + `template` relation (cascade delete)
  - `orderIndex` (Int) with `@@unique([templateId, orderIndex])`
  - `muscleGroup` (String ‚Äî e.g., "chest", "back", "quads")
  - `exerciseCount` (default 1) ‚Äî number of exercises to fill for this muscle group
  - `patternConstraints` (Json ‚Äî {allowedPatterns?, excludedPatterns?})
  - `equipmentConstraints` (Json ‚Äî {allowedTypes?, excludedTypes?})
  - `defaultSets` (default 3), `defaultRepMin` (default 8), `defaultRepMax` (default 12), `notes` (nullable)
- Created two new enums: `TemplateMode` (FIXED, SLOT), `ProgressionEngine` (DOUBLE_PROGRESSION, STRAIGHT_SETS, TOP_SET_BACKOFF, RPE_BASED, NONE)
- Updated `SplitScheduleDay` with proper foreign key relation to `WorkoutDayTemplate` (onDelete: SetNull)
- Added `workoutDayTemplates` relation on User model
- Added `workoutDayBlocks` relation on Exercise model
- Added indexes: `[userId]` on workout_day_templates, `[templateId]` on blocks and slots
- Migration file: `prisma/migrations/20260218001249_add_day_templates_schema/migration.sql`
- Ran `prisma migrate dev --name add_day_templates_schema` ‚Üí migration applied successfully
- Template supports both modes: FIXED uses WorkoutDayBlock[], SLOT uses WorkoutDaySlot[]
- Verified: No linter errors in schema file

### Task 2.6 ‚Äî Add workouts schema (sessions/exercises/sets) ‚úÖ
- Added `WorkoutSession` model in `prisma/schema.prisma` representing actual performed workout logs:
  - `startedAt` (DateTime), `endedAt` (nullable DateTime)
  - `status` (enum: ACTIVE, COMPLETED, ABANDONED) ‚Äî session lifecycle tracking
  - `title` (nullable String ‚Äî auto-generated or user-set)
  - `notes` (nullable String ‚Äî user can add notes during/after workout)
  - `userId` + `user` relation (cascade delete)
  - `splitId` + `split` relation (nullable, onDelete: SetNull) ‚Äî optional link to split
  - `templateId` + `template` relation (nullable, onDelete: SetNull) ‚Äî optional link to template
  - `constraintFlags` (Json, default `{}` ‚Äî structure: {pain?, equipmentCrowded?, lowEnergy?})
  - `exercises` relation to `WorkoutExercise`
- Added `WorkoutExercise` model representing exercises performed in a session:
  - `sessionId` + `session` relation (cascade delete)
  - `exerciseId` + `exercise` relation (onDelete: Restrict)
  - `orderIndex` (Int) with `@@unique([sessionId, orderIndex])` ‚Äî allows reordering mid-workout
  - `notes` (nullable String ‚Äî exercise-level notes)
  - `sets` relation to `WorkoutSet`
- Added `WorkoutSet` model representing individual sets with full logging data:
  - `workoutExerciseId` + `workoutExercise` relation (cascade delete)
  - `setIndex` (Int) with `@@unique([workoutExerciseId, setIndex])`
  - `weight` (Float ‚Äî in user's preferred unit system)
  - `reps` (Int)
  - `rpe` (nullable Float) ‚Äî Rate of Perceived Exertion for fatigue tracking
  - `flags` (Json, default `{}` ‚Äî structure: {warmup?, backoff?, dropset?, failure?}) ‚Äî affects volume calculations and PR detection
  - `notes` (nullable String ‚Äî per-set notes)
- Created `SessionStatus` enum: ACTIVE, COMPLETED, ABANDONED
- Added relations: User ‚Üí workoutSessions, Split ‚Üí workoutSessions, WorkoutDayTemplate ‚Üí workoutSessions, Exercise ‚Üí workoutExercises
- Added indexes: `[userId]`, `[userId, startedAt]`, `[userId, status]` on workout_sessions; `[sessionId]`, `[exerciseId]` on workout_exercises; `[workoutExerciseId]` on workout_sets
- Migration file: `prisma/migrations/20260218001515_add_workouts_schema/migration.sql`
- Ran `prisma migrate dev --name add_workouts_schema` ‚Üí migration applied successfully
- Set flags persist as JSONB in PostgreSQL, typed as `Prisma.JsonValue` in TypeScript
- Verified: `prisma migrate status` shows "6 migrations found, Database schema is up to date!"
- Verified: `tsc --noEmit` passes with no errors

### Task 2.7 ‚Äî Add versioning schema (program blocks + versions) ‚úÖ
- Added `ProgramBlock` model in `prisma/schema.prisma` representing training program phases:
  - `name` (String ‚Äî e.g., "Hypertrophy Block 1", "Strength Phase", "Peaking")
  - `startDate` (DateTime), `endDate` (nullable DateTime) ‚Äî block date range
  - `userId` + `user` relation (cascade delete)
  - `routineVersions` relation to `RoutineVersion`
- Added `RoutineVersion` model for storing routine snapshots at points in time:
  - `userId` + `user` relation (cascade delete)
  - `programBlockId` + `programBlock` relation (nullable, onDelete: SetNull) ‚Äî links version to training phase
  - `changelog` (nullable String ‚Äî human-readable description of what changed)
  - `versionNumber` (Int ‚Äî for ordering and identification)
  - `snapshotJson` (Json) ‚Äî denormalized snapshot of complete routine state:
    - Structure: {splitId, splitName, scheduleDays[], templates[], favoriteIds[]}
    - Enables reliable rollback even if underlying templates/splits are modified or deleted
  - `changeLogsFrom` / `changeLogsTo` relations for change tracking
- Added `RoutineChangeLog` model for recording specific changes between versions:
  - `userId` + `user` relation (cascade delete)
  - `fromVersionId` + `fromVersion` relation (cascade delete)
  - `toVersionId` + `toVersion` relation (cascade delete)
  - `proposalId` (nullable String ‚Äî links to coach proposal if AI-initiated)
  - `patchOpsJson` (Json) ‚Äî array of JSON Patch operations (RFC 6902) describing exact changes
- Created `ProposalStatus` enum: PENDING, ACCEPTED, REJECTED (for future Task 2.8)
- Added relations on User model: `programBlocks`, `routineVersions`, `routineChangeLogs`
- Added indexes: `[userId]`, `[userId, startDate]` on program_blocks; `[userId]`, `[userId, versionNumber]`, `[programBlockId]` on routine_versions; `[userId]`, `[fromVersionId]`, `[toVersionId]`, `[proposalId]` on routine_change_logs
- Migration file: `prisma/migrations/20260218002515_add_versioning_schema/migration.sql`
- Ran `prisma migrate dev --name add_versioning_schema` ‚Üí migration applied successfully
- Version snapshot JSON field exists as `snapshotJson Json @map("snapshot_json")` ‚Üí `"snapshot_json" JSONB NOT NULL` in migration SQL
- Verified: `prisma migrate status` shows "7 migrations found, Database schema is up to date!"

### Task 2.8 ‚Äî Add coach proposals schema ‚úÖ
- Added `CoachProposal` model in `prisma/schema.prisma` for AI-generated coach proposals:
  - `userId` + `user` relation (cascade delete)
  - `type` (enum: NEXT_SESSION, WEEKLY, PLATEAU, GOALS) ‚Äî the 4 coach proposal types
  - `status` (ProposalStatus: PENDING, ACCEPTED, REJECTED) ‚Äî proposal lifecycle
  - `inputSummaryHash` (String) ‚Äî hash of input data for caching/deduplication
  - `proposalJson` (Json) ‚Äî AI-generated proposal content, structure varies by type:
    - NEXT_SESSION: { exercises: [...], notes: string }
    - WEEKLY: { patches: [...], rationale: string, volumeAnalysis: {...} }
    - PLATEAU: { diagnosis: string, interventions: [...] }
    - GOALS: { goals: [...], guardrails: [...] }
  - `rationale` (nullable String) ‚Äî optional AI explanation for display
  - `changeLogs` relation to `RoutineChangeLog` ‚Äî changes triggered by accepting this proposal
- Created `ProposalType` enum: NEXT_SESSION, WEEKLY, PLATEAU, GOALS
- Updated `RoutineChangeLog.proposalId` with proper foreign key relation to `CoachProposal` (onDelete: SetNull)
- Added `coachProposals` relation on User model
- Added indexes: `[userId]`, `[userId, type]`, `[userId, status]`, `[inputSummaryHash]` on coach_proposals
- Migration file: `prisma/migrations/20260218002738_add_coach_proposals_schema/migration.sql`
- Ran `prisma migrate dev --name add_coach_proposals_schema` ‚Üí migration applied successfully
- Verified: `prisma validate` shows "The schema at prisma/schema.prisma is valid üöÄ"
- Verified: `prisma generate` successfully generated Prisma Client

### Task 3.1 ‚Äî API auth guard helper ‚úÖ
- Created `src/lib/auth/require-auth.ts` with server-side authentication helpers:
  - `requireAuth()` ‚Äî returns discriminated union for route handlers:
    - Success: `{ success: true, userId: string, email: string }`
    - Failure: `{ success: false, response: NextResponse }` (401 Unauthorized)
  - `getAuthUserId()` ‚Äî returns `userId` or throws Error (for server actions)
  - `getAuthUser()` ‚Äî returns `{ userId, email }` or throws Error (for server actions)
- Created `src/lib/auth/index.ts` barrel export consolidating all auth exports:
  - Re-exports `authOptions`, `createUser`, `userExists` from auth.config
  - Re-exports `requireAuth`, `getAuthUserId`, `getAuthUser`, `AuthResult` from require-auth
- Uses `getServerSession(authOptions)` from next-auth for session retrieval
- Returns 401 JSON response with `{ error: 'Unauthorized', message: 'Authentication required' }` when unauthenticated
- Usage pattern documented in JSDoc with code examples
- Verified: `npm run build` passes, `tsc --noEmit` passes, `npm run lint` clean

### Task 3.2 ‚Äî Exercises API: list + create custom ‚úÖ
- Created `src/app/api/exercises/route.ts` with two endpoints:
  - `GET /api/exercises` ‚Äî lists exercises (system + user's custom)
  - `POST /api/exercises` ‚Äî creates a custom exercise owned by authenticated user
- GET endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Returns system exercises (`isCustom=false`) + user's custom exercises (`isCustom=true, ownerUserId=userId`)
  - Supports query filters: `customOnly`, `pattern`, `type`, `search` (partial name match, case-insensitive)
  - Zod schema validation for query parameters
  - Orders by isCustom (system first), then name ascending
- POST endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Zod schema validation for request body (name required, type/pattern/muscleGroups/equipmentTags/jointStressFlags optional with defaults)
  - Duplicate name check per user (case-insensitive) ‚Üí 409 Conflict
  - Creates exercise with `isCustom=true` and `ownerUserId=userId`
  - Returns 201 with created exercise object
- Validation schemas:
  - `listExercisesQuerySchema` ‚Äî validates GET query params
  - `createExerciseSchema` ‚Äî validates POST body with ExerciseType and MovementPattern enums
- Verified: `tsc --noEmit` passes, `eslint` clean

### Task 3.3 ‚Äî Favorites API: toggle ‚úÖ
- Created `src/app/api/favorites/[exerciseId]/route.ts` with toggle endpoint:
  - `POST /api/favorites/:exerciseId` ‚Äî toggles favorite status for an exercise
- Toggle behavior (idempotent):
  - If not favorited: creates favorite with provided priority/tags ‚Üí returns `{ favorited: true, exerciseId, favorite: {...} }`
  - If already favorited: deletes favorite ‚Üí returns `{ favorited: false, exerciseId }`
- Uses `requireAuth()` to get authenticated userId
- Validates exerciseId param exists and exercise is accessible (system OR user's custom)
- Zod schema validation for optional request body:
  - `priority` (FavoritePriority: PRIMARY, BACKUP) ‚Äî default PRIMARY
  - `tags` (string array) ‚Äî default []
- Uses Prisma `@@unique([userId, exerciseId])` constraint on Favorite model for guaranteed uniqueness
- Returns 404 if exercise not found or not accessible
- Returns 401 if unauthenticated
- Verified: `tsc --noEmit` passes, `eslint` clean
- Verified: `next build` succeeds with `/api/favorites/[exerciseId]` registered as dynamic route

### Task 3.4 ‚Äî Splits API: create/list/update ‚úÖ
- Created `src/app/api/splits/route.ts` with two endpoints:
  - `GET /api/splits` ‚Äî lists all splits owned by the authenticated user
  - `POST /api/splits` ‚Äî creates a new split with optional schedule days
- Created `src/app/api/splits/[id]/route.ts` with update endpoint:
  - `PUT /api/splits/:id` ‚Äî updates an existing split (name, isActive, scheduleDays)
- GET endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Always scoped to `userId` in where clause
  - Supports `activeOnly=true` query filter to return only active split
  - Returns splits with nested `scheduleDays` including linked `workoutDayTemplate` details
  - Orders by isActive (active first), then updatedAt descending
- POST endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Zod schema validation for request body (name required, isActive optional, scheduleDays optional)
  - If `isActive=true`, deactivates all other user splits before creating
  - Validates that all `workoutDayTemplateId` references belong to the authenticated user
  - Creates split with nested `scheduleDays` in single Prisma create
  - Returns 201 with created split including schedule days
- PUT endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Validates split exists and belongs to authenticated user (404 if not found)
  - Zod schema validation for request body (all fields optional)
  - If `isActive=true` and split wasn't active, deactivates all other user splits
  - Validates that all `workoutDayTemplateId` references belong to the authenticated user
  - If `scheduleDays` provided, replaces all existing days (delete + create in transaction)
  - Simple updates (name/isActive only) don't require transaction
- Validation schemas:
  - `listSplitsQuerySchema` ‚Äî validates GET query params
  - `scheduleDaySchema` ‚Äî validates weekday (Weekday enum), workoutDayTemplateId, isRest, label
  - `createSplitSchema` ‚Äî validates POST body
  - `updateSplitSchema` ‚Äî validates PUT body (all fields optional)
- CRUD scoped to user: All operations filter by `userId`, template ID validation checks ownership
- Verified: `tsc --noEmit` passes, `eslint` clean
- Verified: `npm run build` succeeds with `/api/splits` and `/api/splits/[id]` registered as dynamic routes

### Task 3.5 ‚Äî Splits API: activate split ‚úÖ
- Created `src/app/api/splits/[id]/activate/route.ts` with activation endpoint:
  - `POST /api/splits/:id/activate` ‚Äî activates the specified split for the authenticated user
- Activation behavior:
  - Uses Prisma `$transaction` to atomically deactivate any currently active splits and activate the target split
  - Deactivates all other splits where `userId` matches and `isActive=true` and `id ‚â† target`
  - Then sets `isActive=true` on the target split
  - Ensures only one active split per user (app-level enforcement)
- Idempotency:
  - If the split is already active, returns success without modifications (`message: 'Split is already active'`)
  - No side effects when called multiple times on an already-active split
- Uses `requireAuth()` to get authenticated userId
- Validates split ID exists and belongs to authenticated user (404 if not found)
- Returns split object with nested `scheduleDays` including linked `workoutDayTemplate` details
- Zod schema validation for split ID param
- Verified: `tsc --noEmit` passes with no errors
- Verified: No linter errors in new route file

### Task 3.6 ‚Äî Templates API: create/list/update ‚úÖ
- Created `src/app/api/templates/route.ts` with two endpoints:
  - `GET /api/templates` ‚Äî lists all workout day templates owned by the authenticated user
  - `POST /api/templates` ‚Äî creates a new template with support for FIXED or SLOT mode
- Created `src/app/api/templates/[id]/route.ts` with update endpoint:
  - `PUT /api/templates/:id` ‚Äî updates an existing template (name, progressionEngine, notes, estimatedMinutes, blocks/slots)
- GET endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Always scoped to `userId` in where clause
  - Supports query filters: `mode` (TemplateMode enum), `search` (partial name match, case-insensitive)
  - Returns templates with nested `blocks` (for FIXED) and `slots` (for SLOT) including exercise details
  - Orders by updatedAt descending
- POST endpoint features (supports fixed + slot mode payloads):
  - Uses `requireAuth()` to get authenticated userId
  - Zod schema validation for request body with mode-aware refinement
  - FIXED mode: accepts `blocks` array with exerciseId, orderIndex, setsPlanned, repMin, repMax, restSeconds, progressionEngine, intensityTarget, notes
  - SLOT mode: accepts `slots` array with muscleGroup, exerciseCount, orderIndex, patternConstraints, equipmentConstraints, defaultSets, defaultRepMin, defaultRepMax, notes
  - Validates mode-appropriate data (FIXED templates cannot have slots, SLOT templates cannot have blocks)
  - Validates that all exercise IDs in blocks belong to user or are system exercises
  - Uses `exercise: { connect: { id } }` pattern and `Prisma.JsonNull` for null JSON fields
  - Returns 201 with created template including blocks/slots
- PUT endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Validates template exists and belongs to authenticated user (404 if not found)
  - Zod schema validation for request body (all fields optional)
  - Enforces mode-appropriate updates (cannot add slots to FIXED template, cannot add blocks to SLOT template)
  - Mode cannot be changed after creation
  - If `blocks`/`slots` provided, replaces all existing ones (delete + create in transaction)
  - Simple updates (name/notes/etc only) don't require transaction
  - Validates that all exercise IDs in blocks belong to user or are system exercises
- Validation schemas:
  - `listTemplatesQuerySchema` ‚Äî validates GET query params
  - `workoutDayBlockSchema` ‚Äî validates FIXED template blocks with ProgressionEngine enum
  - `workoutDaySlotSchema` ‚Äî validates SLOT template slots with MovementPattern and ExerciseType enums
  - `createTemplateSchema` ‚Äî validates POST body with mode-aware refinement
  - `updateTemplateSchema` ‚Äî validates PUT body (all fields optional)
- Verified: `tsc --noEmit` passes with no errors
- Verified: No linter errors in new route files
- Verified: `npm run build` succeeds with `/api/templates` and `/api/templates/[id]` registered as dynamic routes

### Task 3.7 ‚Äî Workouts API: start session ‚úÖ
- Created `src/app/api/workouts/start/route.ts` with start session endpoint:
  - `POST /api/workouts/start` ‚Äî starts a new workout session for the authenticated user
- Endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Zod schema validation for request body with all optional fields:
    - `splitId` (optional String) ‚Äî links session to a workout split
    - `templateId` (optional String) ‚Äî links session to a workout day template
    - `title` (optional String, max 200 chars) ‚Äî auto-generated or user-set session title
    - `notes` (optional String) ‚Äî initial session notes
    - `constraintFlags` (optional object: {pain?: string[], equipmentCrowded?: boolean, lowEnergy?: boolean})
  - Allows empty request body for completely freestyle workouts
  - Validates that `splitId` belongs to authenticated user if provided (404 if not found)
  - Validates that `templateId` belongs to authenticated user if provided (404 if not found)
  - Creates `WorkoutSession` with:
    - `status: 'ACTIVE'`
    - `startedAt: new Date()` (current timestamp)
    - User-provided or null values for title, notes, splitId, templateId, constraintFlags
- Response structure:
  - `sessionId` ‚Äî the ID of the created session (top-level for easy access)
  - `session` ‚Äî full session object including:
    - id, startedAt, status, title, notes, constraintFlags, splitId, templateId, createdAt
    - `split` relation (id, name) if splitId was provided
    - `template` relation (id, name, mode) if templateId was provided
  - HTTP 201 Created status
- Error responses:
  - 401 Unauthorized if not authenticated
  - 400 Bad Request if validation fails
  - 404 Not Found if splitId or templateId doesn't exist or doesn't belong to user
- Verified: `tsc --noEmit` passes with no errors
- Verified: No linter errors in new route file (`npx eslint src/app/api/workouts/start/route.ts`)

### Task 3.8 ‚Äî Workouts API: log set ‚úÖ
- Created `src/app/api/workouts/[id]/log-set/route.ts` with log set endpoint:
  - `POST /api/workouts/:id/log-set` ‚Äî logs a single set for an exercise within a workout session
- Endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Zod schema validation for request body:
    - `exerciseId` (required String) ‚Äî exercise to log the set for
    - `weight` (required Number, non-negative) ‚Äî weight used
    - `reps` (required Int, positive) ‚Äî reps performed
    - `rpe` (optional Number, 1-10) ‚Äî Rate of Perceived Exertion
    - `flags` (optional object: {warmup?, backoff?, dropset?, failure?}) ‚Äî set type flags
    - `notes` (optional String) ‚Äî per-set notes
  - Validates that session exists and belongs to authenticated user (404 if not found)
  - Validates that session is ACTIVE (400 if COMPLETED or ABANDONED)
  - Validates that exercise exists and is accessible (system OR user's custom exercise)
- Auto-creates WorkoutExercise if missing:
  - If exercise hasn't been logged in this session yet, creates a new `WorkoutExercise` entry
  - Automatically assigns next available `orderIndex` within the session
  - Enables freestyle workouts ‚Äî users can add any exercise mid-workout
- Set logging behavior:
  - Automatically assigns next available `setIndex` within the exercise
  - Sets append correctly in order ‚Äî each new set gets `setIndex = max(existing) + 1`
  - Preserves all flags (warmup, backoff, dropset, failure) in the set's `flags` JSON field
  - Uses Prisma `$transaction` for atomic find-or-create + append operations
- Response structure:
  - `set` ‚Äî the created WorkoutSet object (id, setIndex, weight, reps, rpe, flags, notes, createdAt)
  - `exercise` ‚Äî exercise context (id, name, workoutExerciseId, orderIndex)
  - `sessionId` ‚Äî the session ID for reference
  - HTTP 201 Created status
- Error responses:
  - 401 Unauthorized if not authenticated
  - 400 Bad Request if validation fails or session is not active
  - 404 Not Found if session or exercise doesn't exist or isn't accessible
- Verified: `tsc --noEmit` passes with no errors
- Verified: No linter errors in new route file

### Task 3.9 ‚Äî Workouts API: end session ‚úÖ
- Created `src/app/api/workouts/[id]/end/route.ts` with end session endpoint:
  - `POST /api/workouts/:id/end` ‚Äî ends a workout session and records the end time
- Endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Zod schema validation for request body (all optional):
    - `notes` (optional String) ‚Äî final session notes
    - `status` (optional enum: 'COMPLETED', 'ABANDONED') ‚Äî defaults to COMPLETED
  - Allows empty request body for default completion
  - Validates that session exists and belongs to authenticated user (404 if not found)
  - Validates that session is ACTIVE (400 if already COMPLETED or ABANDONED)
- Session ending behavior:
  - Sets `endedAt` to current timestamp (`new Date()`)
  - Updates `status` to COMPLETED (default) or ABANDONED if explicitly specified
  - Merges final notes if provided (replaces existing notes)
  - Returns full session object with related split/template data
- Response structure:
  - `session` ‚Äî the updated WorkoutSession object including:
    - id, startedAt, endedAt, status, title, notes, constraintFlags, splitId, templateId, createdAt, updatedAt
    - `split` relation (id, name) if session had a splitId
    - `template` relation (id, name, mode) if session had a templateId
    - `exercises` array with exercise summaries and set counts
    - `durationMinutes` ‚Äî calculated session duration in minutes
  - `message` ‚Äî success message based on status (completed/abandoned)
- Error responses:
  - 401 Unauthorized if not authenticated
  - 400 Bad Request if validation fails or session is already ended
  - 404 Not Found if session doesn't exist or doesn't belong to user
- Verified: `tsc --noEmit` passes with no errors
- Verified: No linter errors in new route file (`npx eslint src/app/api/workouts/[id]/end/route.ts`)

### Task 3.10 ‚Äî History API: list sessions ‚úÖ
- Created `src/app/api/history/route.ts` with list sessions endpoint:
  - `GET /api/history` ‚Äî lists workout sessions for the authenticated user with date range filtering
- Endpoint features:
  - Uses `requireAuth()` to get authenticated userId
  - Zod schema validation for query parameters:
    - `startDate` (optional ISO 8601 datetime) ‚Äî filter sessions starting from this date
    - `endDate` (optional ISO 8601 datetime) ‚Äî filter sessions ending before this date
    - `limit` (optional Int, 1-100, default 50) ‚Äî pagination limit
    - `offset` (optional Int, min 0, default 0) ‚Äî pagination offset
    - `status` (optional enum: 'ACTIVE', 'COMPLETED', 'ABANDONED') ‚Äî filter by session status
  - Always scoped to `userId` in where clause
  - Sessions sorted by `startedAt` descending (most recent first)
- Response structure:
  - `sessions` ‚Äî array of workout sessions including:
    - id, startedAt, endedAt, status, title, notes, constraintFlags, createdAt, updatedAt
    - `split` relation (id, name) if session had a splitId
    - `template` relation (id, name, mode) if session had a templateId
    - `exercises` array with exercise details and set counts
    - `durationMinutes` ‚Äî calculated session duration (null if not ended)
    - `summary` ‚Äî { totalExercises, totalSets } for quick stats
  - `pagination` ‚Äî { total, limit, offset, hasMore } for pagination info
- Error responses:
  - 401 Unauthorized if not authenticated
  - 400 Bad Request if query param validation fails
- Verified: `tsc --noEmit` passes with no errors
- Verified: No linter errors in new route file
- Verified: `npm run build` succeeds with `/api/history` registered as dynamic route

### Task 4.1 ‚Äî Add IndexedDB schema (Dexie) ‚úÖ
- Created `src/lib/offline/db.ts` with Dexie IndexedDB database schema:
  - Database class `SwoleAIDatabase` extends Dexie with name 'SwoleAI'
  - Schema version 1 with three tables for offline-first workout logging
- **`activeSession` table**:
  - Primary key: `id` (always 'current' ‚Äî singleton pattern for one active session)
  - `ActiveSession` interface with fields:
    - `id`, `serverSessionId` (optional), `startedAt` (Date)
    - `splitId`, `templateId`, `title`, `notes` (all optional)
    - `constraintFlags` (optional object: pain[], equipmentCrowded, lowEnergy)
    - `exercises` (array of `ActiveSessionExercise` with nested `ActiveSessionSet` arrays)
    - `updatedAt` (Date ‚Äî for conflict detection)
  - `ActiveSessionExercise` interface: localId, exerciseId, exerciseName, orderIndex, notes, sets[]
  - `ActiveSessionSet` interface: localId, setIndex, weight, reps, rpe, flags, notes, loggedAt
- **`setEvents` table** (append-only event log):
  - Primary key: `++id` (auto-incremented)
  - Indexes: `serverSessionId`, `synced`, `timestamp`, `localExerciseId`
  - `SetEvent` interface with fields:
    - `id`, `serverSessionId`, `localExerciseId`
    - `eventType` enum: 'SET_LOGGED' | 'SET_UPDATED' | 'SET_DELETED'
    - `payload` object containing set data (localSetId, setIndex, weight, reps, rpe, flags, notes)
    - `timestamp` (Date), `synced` (boolean)
  - Used for event sourcing ‚Äî can reconstruct session state from events
- **`pendingMutations` table** (sync queue):
  - Primary key: `++id` (auto-incremented)
  - Indexes: `status`, `createdAt`, `type`
  - `PendingMutation` interface with fields:
    - `id`, `type` (MutationType enum), `payload` (Record<string, unknown>)
    - `createdAt` (Date), `retryCount` (number), `lastError` (optional string)
    - `status` enum: 'pending' | 'processing' | 'failed'
  - `MutationType` union: START_SESSION, END_SESSION, LOG_SET, UPDATE_SET, DELETE_SET, ADD_EXERCISE, REMOVE_EXERCISE, REORDER_EXERCISES, UPDATE_SESSION_NOTES
- Created `src/lib/offline/index.ts` exporting:
  - `db` (singleton database instance), `SwoleAIDatabase` class
  - All type interfaces: `ActiveSession`, `ActiveSessionExercise`, `ActiveSessionSet`, `SetEvent`, `PendingMutation`, `MutationType`
- Verified: `tsc --noEmit` passes with no errors
- Verified: `npm run lint` passes with no errors
- Verified: `npm run build` succeeds ‚Äî database module compiles correctly

### Task 4.2 ‚Äî Active session persistence (continue workout) ‚úÖ
- Created `src/lib/offline/session.ts` with session persistence functions:
  - **Core functions**:
    - `saveActiveSession(session)` ‚Äî saves session state to IndexedDB (overwrites existing, sets `id: 'current'` and `updatedAt`)
    - `getActiveSession()` ‚Äî retrieves the current active session from IndexedDB
    - `hasActiveSession()` ‚Äî checks if an active session exists (returns boolean)
    - `clearActiveSession()` ‚Äî deletes the active session (called when workout ends)
    - `updateActiveSession(updates)` ‚Äî partial updates to active session fields
  - **Exercise management**:
    - `addExerciseToSession(exercise)` ‚Äî adds exercise with auto-assigned orderIndex
    - `removeExerciseFromSession(localId)` ‚Äî removes exercise and reindexes remaining
    - `updateExerciseInSession(localId, updates)` ‚Äî updates exercise fields
  - **Set management**:
    - `addSetToExercise(exerciseLocalId, set)` ‚Äî adds set to exercise
    - `updateSetInExercise(exerciseLocalId, setLocalId, updates)` ‚Äî updates set fields
    - `removeSetFromExercise(exerciseLocalId, setLocalId)` ‚Äî removes set and reindexes
- Created `src/lib/offline/useActiveSession.ts` React hook:
  - Uses Dexie's `useLiveQuery` for reactive session restoration on app reload
  - Automatically queries `db.activeSession.get('current')` on mount ‚Äî restores any persisted session
  - Provides state: `session` (ActiveSession | undefined | null), `isLoading`, `error`
  - Provides mutation functions: `startSession`, `endSession`, `addExercise`, `removeExercise`, `updateExercise`, `logSet`, `updateSet`, `removeSet`, `updateSessionMeta`
  - `StartSessionOptions` interface: splitId, templateId, title, initialExercises (all optional)
  - Error handling with `mountedRef` to prevent state updates after unmount
- Created `src/lib/offline/ActiveSessionProvider.tsx` context provider:
  - Wraps app to provide session state to all children via React Context
  - `useActiveSessionContext()` hook for consuming session state (throws if used outside provider)
  - Enables any component to access session state without prop drilling
- Updated `src/lib/offline/index.ts` with new exports:
  - Session functions: `saveActiveSession`, `getActiveSession`, `hasActiveSession`, `clearActiveSession`, `updateActiveSession`, exercise/set management functions
  - Hook: `useActiveSession`, types `UseActiveSessionReturn`, `StartSessionOptions`
  - Provider: `ActiveSessionProvider`, `useActiveSessionContext`
- Verified: `tsc --noEmit` passes with no errors
- Verified: `npm run lint` passes with no errors
- Verified: `npm run build` succeeds ‚Äî all session modules compile correctly

### Task 4.3 ‚Äî Mutation queue (push) ‚úÖ
- Created `src/lib/offline/mutations.ts` with mutation queue functions:
  - **Queue operations**:
    - `enqueueMutation(type, payload)` ‚Äî adds a mutation to the pending queue with status 'pending'
    - `getPendingMutations()` ‚Äî retrieves all pending mutations sorted by createdAt (oldest first)
    - `getPendingMutationCount()` ‚Äî returns count of pending mutations
    - `getFailedMutations()` ‚Äî retrieves all failed mutations for retry/inspection
  - **Status management**:
    - `markMutationProcessing(id)` ‚Äî marks mutation as 'processing' (being synced)
    - `markMutationFailed(id, error)` ‚Äî marks mutation as 'failed', increments retryCount, stores error
    - `removeMutation(id)` ‚Äî deletes successfully synced mutation from queue
    - `retryMutation(id)` ‚Äî resets failed mutation to 'pending' for retry
  - **Cleanup**:
    - `clearAllMutations()` ‚Äî clears entire queue (for logout/reset)
    - `resetProcessingMutations()` ‚Äî resets stuck 'processing' mutations to 'pending' (app startup recovery)
- Created `src/lib/offline/sync.ts` with background sync service:
  - **SyncService class** (singleton pattern):
    - Listens for browser `online`/`offline` events to detect network state changes
    - Runs sync loop every 5 seconds (`SYNC_INTERVAL_MS = 5000`)
    - Processes mutations in order (FIFO) to maintain consistency
    - Max 3 retries per mutation (`MAX_RETRIES = 3`) before marking as permanently failed
  - **SyncState interface**: `status`, `pendingCount`, `lastSyncAt`, `lastError`, `isOnline`
  - **SyncStatus type**: 'synced' | 'pending' | 'syncing' | 'offline' | 'error'
  - **Key methods**:
    - `initialize()` ‚Äî sets up event listeners and starts sync loop (idempotent)
    - `destroy()` ‚Äî cleanup for unmount
    - `subscribe(listener)` ‚Äî reactive state updates
    - `triggerSync()` ‚Äî force immediate sync attempt
    - `notifyMutationAdded()` ‚Äî triggers immediate sync when new mutation added while online
  - **Mutation execution**:
    - Maps mutation types to API endpoints and HTTP methods
    - Builds URLs with path parameters from payload (sessionId, setId, exerciseId)
    - Handles network errors gracefully, stops processing on connectivity issues
- Created `src/lib/offline/useSync.ts` React hook:
  - `useSync()` hook returns: `status`, `pendingCount`, `isOnline`, `lastSyncAt`, `lastError`, `syncState`, `triggerSync`
  - Initializes sync service on mount, subscribes to state changes
  - Provides reactive updates when sync status changes
- Updated `src/lib/offline/useActiveSession.ts` to enqueue mutations:
  - `startSession` ‚Üí enqueues `START_SESSION` mutation
  - `endSession` ‚Üí enqueues `END_SESSION` mutation (if serverSessionId exists)
  - `addExercise` ‚Üí enqueues `ADD_EXERCISE` mutation
  - `removeExercise` ‚Üí enqueues `REMOVE_EXERCISE` mutation
  - `logSet` ‚Üí enqueues `LOG_SET` mutation with exerciseId, weight, reps, rpe, flags, notes
  - `updateSet` ‚Üí enqueues `UPDATE_SET` mutation
  - `removeSet` ‚Üí enqueues `DELETE_SET` mutation
  - `updateSessionMeta` ‚Üí enqueues `UPDATE_SESSION_NOTES` mutation
  - All operations call `syncService.notifyMutationAdded()` to trigger immediate sync if online
- Updated `src/lib/offline/index.ts` with new exports:
  - Mutation functions: `enqueueMutation`, `getPendingMutations`, `getPendingMutationCount`, `getFailedMutations`, `markMutationProcessing`, `markMutationFailed`, `removeMutation`, `retryMutation`, `clearAllMutations`, `resetProcessingMutations`
  - Sync exports: `syncService`, types `SyncStatus`, `SyncState`
  - Hook: `useSync`, type `UseSyncReturn`
- Verified: `tsc --noEmit` passes with no errors
- Verified: `npm run lint` passes with no errors
- Verified: `npm run build` succeeds ‚Äî all sync modules compile correctly

### Task 4.4 ‚Äî Sync status pill ‚úÖ
- Created `src/components/ui/SyncStatusPill.tsx` ‚Äî global sync indicator component:
  - Uses `useSync()` hook from Task 4.3 to read sync status
  - Displays 5 distinct states with appropriate icons and colors:
    - **synced** (green checkmark) ‚Äî all changes synced
    - **pending** (amber RefreshCw) ‚Äî changes waiting to sync, shows count (e.g., "3 pending")
    - **syncing** (amber spinning Loader2) ‚Äî actively syncing, shows count (e.g., "Syncing 2")
    - **offline** (gray CloudOff) ‚Äî device offline
    - **error** (red AlertCircle) ‚Äî sync failed, clickable to retry
  - Status config object maps each status to icon, label, CSS class, and animation flag
  - Error state is interactive ‚Äî clicking triggers `triggerSync()` for manual retry
  - Accessible: includes `aria-label` for screen readers and tooltip on error state
  - Lucide icons: Check, CloudOff, RefreshCw, AlertCircle, Loader2
- Updated `src/app/globals.css` ‚Äî added offline status pill style:
  - `.status-pill--offline` with gray background (`rgba(113, 113, 122, 0.15)`) and muted text color
  - Complements existing `.status-pill--success`, `--warning`, `--error`, `--info` variants
- Updated `src/components/layout/AppShell.tsx` ‚Äî integrated global sync indicator:
  - Added sticky header with `SyncStatusPill` component
  - Header styled with glass effect: `bg-[var(--color-base-800)]/95 backdrop-blur-lg`
  - Positioned at top-right per design spec section 2.3 ("Global sync pill (top of Dashboard, Settings)")
  - Safe area padding for PWA notch handling
- Updated `src/components/ui/index.ts` ‚Äî exported `SyncStatusPill`
- Verified: `tsc --noEmit` passes with no errors
- Verified: `npm run lint` passes with no errors (CSS warning expected)
- Verified: `npm run build` succeeds ‚Äî production build compiles correctly
