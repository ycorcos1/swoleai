// Prisma schema for SwoleAI
// Using Neon Postgres as the database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum GoalMode {
  HYPERTROPHY
  STRENGTH
  HYBRID
}

enum UnitSystem {
  METRIC
  IMPERIAL
}

enum EquipmentAccess {
  COMMERCIAL
  HOME
}

// Exercise type enum (Task 2.3)
// Represents the equipment/style of the exercise
enum ExerciseType {
  BARBELL
  DUMBBELL
  MACHINE
  CABLE
  BODYWEIGHT
  OTHER
}

// Movement pattern enum (Task 2.3)
// Used for substitution matching and volume tracking
enum MovementPattern {
  HORIZONTAL_PUSH
  HORIZONTAL_PULL
  VERTICAL_PUSH
  VERTICAL_PULL
  HIP_HINGE
  SQUAT
  LUNGE
  ISOLATION
  CARRY
  CORE
  OTHER
}

// Favorite priority enum (Task 2.3)
// Distinguishes primary exercises from backups for slot filling
enum FavoritePriority {
  PRIMARY
  BACKUP
}

// Weekday enum (Task 2.4)
// Maps to split schedule days for weekly programming
enum Weekday {
  SUNDAY    // 0
  MONDAY    // 1
  TUESDAY   // 2
  WEDNESDAY // 3
  THURSDAY  // 4
  FRIDAY    // 5
  SATURDAY  // 6
}

// =============================================================================
// CORE MODELS
// =============================================================================

// User model with profile fields (Task 2.2)
// Profile fields: goal, days/week, session minutes, units, equipment, constraints JSON
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Hashed password for credentials auth
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Profile fields (PRD 8.2 Onboarding Wizard)
  goalMode       GoalMode?        @map("goal_mode")
  daysPerWeek    Int?             @map("days_per_week")
  sessionMinutes Int?             @map("session_minutes")
  units          UnitSystem?      @default(IMPERIAL)
  equipment      EquipmentAccess? @default(COMMERCIAL)

  // Constraints JSON field (PRD 8.2 step 4: injuries/avoid list, must-have lifts)
  // Structure: { injuries: string[], avoidExercises: string[], mustHaveExercises: string[] }
  constraints Json? @default("{}")

  // Onboarding completion flag
  onboardingComplete Boolean @default(false) @map("onboarding_complete")

  // Relations (Task 2.3)
  exercises Exercise[] // Custom exercises owned by this user
  favorites Favorite[] // User's favorite exercises

  // Relations (Task 2.4)
  splits Split[] // User's workout splits (program schedules)

  @@map("users")
}

// =============================================================================
// EXERCISE + FAVORITES (Task 2.3)
// =============================================================================

// Exercise model (Task 2.3)
// Contains both system exercises and user-created custom exercises
// Tags: muscle_groups, pattern, equipment_tags, stress_flags
model Exercise {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Exercise classification
  type    ExerciseType    @default(OTHER)
  pattern MovementPattern @default(OTHER)

  // Muscle groups targeted (e.g., ["chest", "triceps", "front_delts"])
  // Primary and secondary muscle groups for volume tracking
  muscleGroups Json @default("[]") @map("muscle_groups")

  // Equipment tags (e.g., ["barbell", "bench", "rack"])
  // Used for equipment availability filtering
  equipmentTags Json @default("[]") @map("equipment_tags")

  // Joint stress flags for injury/constraint matching
  // (e.g., {"shoulder": "high", "lower_back": "medium"})
  jointStressFlags Json @default("{}") @map("joint_stress_flags")

  // Custom exercise ownership
  // If isCustom is true, ownerUserId points to the creating user
  // System exercises have isCustom=false and ownerUserId=null
  isCustom    Boolean @default(false) @map("is_custom")
  ownerUserId String? @map("owner_user_id")
  owner       User?   @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)

  // Relations
  favorites Favorite[]

  // Index for efficient lookups of user's custom exercises
  @@index([ownerUserId, isCustom])
  @@map("exercises")
}

// Favorite model (Task 2.3)
// Links a user to their favorite exercises with priority
// Used for slot-filling (favorites first) and quick access
model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // User who favorited the exercise
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // The favorited exercise
  exerciseId String   @map("exercise_id")
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  // Priority for slot filling (PRIMARY exercises chosen before BACKUP)
  priority FavoritePriority @default(PRIMARY)

  // Optional tags for organization (e.g., ["chest_day", "push"])
  tags Json @default("[]")

  // Unique constraint: each user can only favorite an exercise once
  @@unique([userId, exerciseId])
  // Index for efficient lookup of user's favorites
  @@index([userId])
  @@map("favorites")
}

// =============================================================================
// SPLITS + SCHEDULE (Task 2.4)
// =============================================================================

// Split model (Task 2.4)
// Represents a workout program schedule (e.g., "Push/Pull/Legs", "Upper/Lower")
// A user can have multiple splits but only one can be active at a time
model Split {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Split name (e.g., "PPL 6-Day", "Upper/Lower")
  name String

  // Whether this split is currently active for the user
  // Only one split per user should be active (enforced at app level)
  // This drives the "Today" workout suggestion on Dashboard
  isActive Boolean @default(false) @map("is_active")

  // Owner relationship
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  scheduleDays SplitScheduleDay[] // Days of the week mapped to templates or rest

  // Index for efficient lookup of user's splits and active split
  @@index([userId])
  @@index([userId, isActive])
  @@map("splits")
}

// SplitScheduleDay model (Task 2.4)
// Maps a weekday to either a workout day template or a rest day
// Part of a Split's weekly schedule
model SplitScheduleDay {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Parent split
  splitId String @map("split_id")
  split   Split  @relation(fields: [splitId], references: [id], onDelete: Cascade)

  // Day of the week (0=Sunday through 6=Saturday)
  weekday Weekday

  // Reference to workout day template (nullable if rest day)
  // Note: WorkoutDayTemplate model will be added in Task 2.5
  // For now, storing as nullable String ID for forward compatibility
  workoutDayTemplateId String? @map("workout_day_template_id")

  // Whether this is a rest day
  // If true, workoutDayTemplateId should be null
  isRest Boolean @default(false) @map("is_rest")

  // Optional label for this day (e.g., "Push A", "Pull B", "Legs")
  // Useful for display when template might not be assigned yet
  label String?

  // Unique constraint: each split can only have one entry per weekday
  @@unique([splitId, weekday])
  // Index for efficient lookup of split's schedule
  @@index([splitId])
  @@map("split_schedule_days")
}
