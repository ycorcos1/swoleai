// Prisma schema for SwoleAI
// Using Neon Postgres as the database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum GoalMode {
  HYPERTROPHY
  STRENGTH
  HYBRID
}

enum UnitSystem {
  METRIC
  IMPERIAL
}

enum EquipmentAccess {
  COMMERCIAL
  HOME
}

// Exercise type enum (Task 2.3)
// Represents the equipment/style of the exercise
enum ExerciseType {
  BARBELL
  DUMBBELL
  MACHINE
  CABLE
  BODYWEIGHT
  OTHER
}

// Movement pattern enum (Task 2.3)
// Used for substitution matching and volume tracking
enum MovementPattern {
  HORIZONTAL_PUSH
  HORIZONTAL_PULL
  VERTICAL_PUSH
  VERTICAL_PULL
  HIP_HINGE
  SQUAT
  LUNGE
  ISOLATION
  CARRY
  CORE
  OTHER
}

// Favorite priority enum (Task 2.3)
// Distinguishes primary exercises from backups for slot filling
enum FavoritePriority {
  PRIMARY
  BACKUP
}

// Template mode enum (Task 2.5)
// Determines how a workout day template defines its exercises
enum TemplateMode {
  FIXED // Explicit exercises with order, sets, reps
  SLOT  // Muscle group slots filled dynamically from favorites/AI
}

// Progression engine enum (Task 2.5)
// Determines how weights/reps progress over time
enum ProgressionEngine {
  DOUBLE_PROGRESSION // Hit rep ceiling â†’ increase weight
  STRAIGHT_SETS      // Fixed sets/reps, increase weight when easy
  TOP_SET_BACKOFF    // Heavy top set + lighter backoffs
  RPE_BASED          // Target RPE per set
  NONE               // No auto-progression (manual)
}

// Weekday enum (Task 2.4)
// Maps to split schedule days for weekly programming
enum Weekday {
  SUNDAY    // 0
  MONDAY    // 1
  TUESDAY   // 2
  WEDNESDAY // 3
  THURSDAY  // 4
  FRIDAY    // 5
  SATURDAY  // 6
}

// Session status enum (Task 2.6)
// Tracks the lifecycle of a workout session
enum SessionStatus {
  ACTIVE    // Currently in progress
  COMPLETED // Finished normally
  ABANDONED // Left incomplete (app closed, user quit)
}

// =============================================================================
// CORE MODELS
// =============================================================================

// User model with profile fields (Task 2.2)
// Profile fields: goal, days/week, session minutes, units, equipment, constraints JSON
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String?  // Hashed password for credentials auth
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Profile fields (PRD 8.2 Onboarding Wizard)
  goalMode       GoalMode?        @map("goal_mode")
  daysPerWeek    Int?             @map("days_per_week")
  sessionMinutes Int?             @map("session_minutes")
  units          UnitSystem?      @default(IMPERIAL)
  equipment      EquipmentAccess? @default(COMMERCIAL)

  // Constraints JSON field (PRD 8.2 step 4: injuries/avoid list, must-have lifts)
  // Structure: { injuries: string[], avoidExercises: string[], mustHaveExercises: string[] }
  constraints Json? @default("{}")

  // Onboarding completion flag
  onboardingComplete Boolean @default(false) @map("onboarding_complete")

  // Relations (Task 2.3)
  exercises Exercise[] // Custom exercises owned by this user
  favorites Favorite[] // User's favorite exercises

  // Relations (Task 2.4)
  splits Split[] // User's workout splits (program schedules)

  // Relations (Task 2.5)
  workoutDayTemplates WorkoutDayTemplate[] // User's saved workout day templates

  // Relations (Task 2.6)
  workoutSessions WorkoutSession[] // User's workout session logs

  @@map("users")
}

// =============================================================================
// EXERCISE + FAVORITES (Task 2.3)
// =============================================================================

// Exercise model (Task 2.3)
// Contains both system exercises and user-created custom exercises
// Tags: muscle_groups, pattern, equipment_tags, stress_flags
model Exercise {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Exercise classification
  type    ExerciseType    @default(OTHER)
  pattern MovementPattern @default(OTHER)

  // Muscle groups targeted (e.g., ["chest", "triceps", "front_delts"])
  // Primary and secondary muscle groups for volume tracking
  muscleGroups Json @default("[]") @map("muscle_groups")

  // Equipment tags (e.g., ["barbell", "bench", "rack"])
  // Used for equipment availability filtering
  equipmentTags Json @default("[]") @map("equipment_tags")

  // Joint stress flags for injury/constraint matching
  // (e.g., {"shoulder": "high", "lower_back": "medium"})
  jointStressFlags Json @default("{}") @map("joint_stress_flags")

  // Custom exercise ownership
  // If isCustom is true, ownerUserId points to the creating user
  // System exercises have isCustom=false and ownerUserId=null
  isCustom    Boolean @default(false) @map("is_custom")
  ownerUserId String? @map("owner_user_id")
  owner       User?   @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)

  // Relations
  favorites Favorite[]

  // Relations (Task 2.5)
  workoutDayBlocks WorkoutDayBlock[] // Blocks that use this exercise

  // Relations (Task 2.6)
  workoutExercises WorkoutExercise[] // Exercise instances in workout sessions

  // Index for efficient lookups of user's custom exercises
  @@index([ownerUserId, isCustom])
  @@map("exercises")
}

// Favorite model (Task 2.3)
// Links a user to their favorite exercises with priority
// Used for slot-filling (favorites first) and quick access
model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // User who favorited the exercise
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // The favorited exercise
  exerciseId String   @map("exercise_id")
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  // Priority for slot filling (PRIMARY exercises chosen before BACKUP)
  priority FavoritePriority @default(PRIMARY)

  // Optional tags for organization (e.g., ["chest_day", "push"])
  tags Json @default("[]")

  // Unique constraint: each user can only favorite an exercise once
  @@unique([userId, exerciseId])
  // Index for efficient lookup of user's favorites
  @@index([userId])
  @@map("favorites")
}

// =============================================================================
// SPLITS + SCHEDULE (Task 2.4)
// =============================================================================

// Split model (Task 2.4)
// Represents a workout program schedule (e.g., "Push/Pull/Legs", "Upper/Lower")
// A user can have multiple splits but only one can be active at a time
model Split {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Split name (e.g., "PPL 6-Day", "Upper/Lower")
  name String

  // Whether this split is currently active for the user
  // Only one split per user should be active (enforced at app level)
  // This drives the "Today" workout suggestion on Dashboard
  isActive Boolean @default(false) @map("is_active")

  // Owner relationship
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  scheduleDays SplitScheduleDay[] // Days of the week mapped to templates or rest

  // Relations (Task 2.6)
  workoutSessions WorkoutSession[] // Sessions performed using this split

  // Index for efficient lookup of user's splits and active split
  @@index([userId])
  @@index([userId, isActive])
  @@map("splits")
}

// SplitScheduleDay model (Task 2.4)
// Maps a weekday to either a workout day template or a rest day
// Part of a Split's weekly schedule
model SplitScheduleDay {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Parent split
  splitId String @map("split_id")
  split   Split  @relation(fields: [splitId], references: [id], onDelete: Cascade)

  // Day of the week (0=Sunday through 6=Saturday)
  weekday Weekday

  // Reference to workout day template (nullable if rest day)
  workoutDayTemplateId String? @map("workout_day_template_id")

  // Whether this is a rest day
  // If true, workoutDayTemplateId should be null
  isRest Boolean @default(false) @map("is_rest")

  // Optional label for this day (e.g., "Push A", "Pull B", "Legs")
  // Useful for display when template might not be assigned yet
  label String?

  // Relation to WorkoutDayTemplate (Task 2.5)
  // Now a proper foreign key instead of String ID
  workoutDayTemplate WorkoutDayTemplate? @relation(fields: [workoutDayTemplateId], references: [id], onDelete: SetNull)

  // Unique constraint: each split can only have one entry per weekday
  @@unique([splitId, weekday])
  // Index for efficient lookup of split's schedule
  @@index([splitId])
  @@map("split_schedule_days")
}

// =============================================================================
// WORKOUT DAY TEMPLATES (Task 2.5)
// =============================================================================

// WorkoutDayTemplate model (Task 2.5)
// Represents a saved workout day configuration (e.g., "Push A", "Upper Body")
// Can be either FIXED (explicit exercises) or SLOT (muscle group placeholders)
model WorkoutDayTemplate {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Template name (e.g., "Push A", "Pull B", "Full Body")
  name String

  // Mode determines how exercises are defined
  // FIXED: Uses WorkoutDayBlock with specific exercises
  // SLOT: Uses WorkoutDaySlot with muscle group placeholders
  mode TemplateMode @default(FIXED)

  // Default progression engine for blocks in this template
  // Can be overridden per block
  defaultProgressionEngine ProgressionEngine @default(DOUBLE_PROGRESSION) @map("default_progression_engine")

  // Optional notes/description for this template
  notes String?

  // Estimated duration in minutes (calculated or user-set)
  estimatedMinutes Int? @map("estimated_minutes")

  // Owner relationship
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  blocks       WorkoutDayBlock[] // For FIXED mode: ordered exercise blocks
  slots        WorkoutDaySlot[]  // For SLOT mode: muscle group slots
  scheduleDays SplitScheduleDay[] // Days that reference this template

  // Relations (Task 2.6)
  workoutSessions WorkoutSession[] // Sessions performed using this template

  // Index for efficient lookup of user's templates
  @@index([userId])
  @@map("workout_day_templates")
}

// WorkoutDayBlock model (Task 2.5)
// Represents a specific exercise slot in a FIXED template
// Defines the exercise, sets, rep range, rest, and progression
model WorkoutDayBlock {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Parent template
  templateId String              @map("template_id")
  template   WorkoutDayTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Order within the template (0-indexed)
  orderIndex Int @map("order_index")

  // Exercise assigned to this block
  exerciseId String   @map("exercise_id")
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Restrict)

  // Set configuration
  setsPlanned Int @default(3) @map("sets_planned")
  repMin      Int @default(8) @map("rep_min")
  repMax      Int @default(12) @map("rep_max")

  // Rest between sets in seconds
  restSeconds Int @default(120) @map("rest_seconds")

  // Override progression engine for this block (optional)
  // If null, uses template's defaultProgressionEngine
  progressionEngine ProgressionEngine? @map("progression_engine")

  // Intensity target (optional)
  // Structure: { rpe?: number, rir?: number, percentOf1RM?: number }
  intensityTarget Json? @map("intensity_target")

  // Notes for this block (e.g., "Focus on slow eccentric")
  notes String?

  // Unique constraint: each template can only have one block per order index
  @@unique([templateId, orderIndex])
  // Index for efficient lookup
  @@index([templateId])
  @@map("workout_day_blocks")
}

// WorkoutDaySlot model (Task 2.5)
// Represents a muscle group placeholder in a SLOT template
// Used for dynamic exercise selection from favorites or AI
model WorkoutDaySlot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Parent template
  templateId String              @map("template_id")
  template   WorkoutDayTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Order within the template (0-indexed)
  orderIndex Int @map("order_index")

  // Target muscle group for this slot (e.g., "chest", "back", "quads")
  muscleGroup String @map("muscle_group")

  // Number of exercises to fill for this muscle group
  exerciseCount Int @default(1) @map("exercise_count")

  // Optional movement pattern constraints
  // Structure: { allowedPatterns?: MovementPattern[], excludedPatterns?: MovementPattern[] }
  patternConstraints Json? @map("pattern_constraints")

  // Optional equipment constraints
  // Structure: { allowedTypes?: ExerciseType[], excludedTypes?: ExerciseType[] }
  equipmentConstraints Json? @map("equipment_constraints")

  // Default sets per exercise in this slot
  defaultSets Int @default(3) @map("default_sets")

  // Default rep range for exercises in this slot
  defaultRepMin Int @default(8) @map("default_rep_min")
  defaultRepMax Int @default(12) @map("default_rep_max")

  // Notes for this slot
  notes String?

  // Unique constraint: each template can only have one slot per order index
  @@unique([templateId, orderIndex])
  // Index for efficient lookup
  @@index([templateId])
  @@map("workout_day_slots")
}

// =============================================================================
// WORKOUT SESSIONS + LOGGING (Task 2.6)
// =============================================================================

// WorkoutSession model (Task 2.6)
// Represents an actual performed workout session (the log)
// Links to user, optionally to split and template for context
model WorkoutSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Session timing
  startedAt DateTime  @map("started_at")
  endedAt   DateTime? @map("ended_at")

  // Session status for lifecycle tracking
  status SessionStatus @default(ACTIVE)

  // Session title (auto-generated or user-set, e.g., "Push A - Jan 15")
  title String?

  // Session notes (user can add notes during/after workout)
  notes String?

  // Owner relationship
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional link to split this session was performed under
  // Nullable because user can do freestyle workouts
  splitId String? @map("split_id")
  split   Split?  @relation(fields: [splitId], references: [id], onDelete: SetNull)

  // Optional link to template this session was based on
  // Nullable because user can do freestyle workouts
  templateId String?             @map("template_id")
  template   WorkoutDayTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Constraint flags for this session (PRD 8.5)
  // Structure: { pain?: string[], equipmentCrowded?: boolean, lowEnergy?: boolean }
  // Influences AI proposals and helps contextualize the session
  constraintFlags Json @default("{}") @map("constraint_flags")

  // Relations
  exercises WorkoutExercise[] // Exercises performed in this session

  // Index for efficient lookup of user's sessions
  @@index([userId])
  @@index([userId, startedAt])
  @@index([userId, status])
  @@map("workout_sessions")
}

// WorkoutExercise model (Task 2.6)
// Represents a specific exercise performed within a workout session
// Contains all sets for that exercise in the session
model WorkoutExercise {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Parent session
  sessionId String         @map("session_id")
  session   WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Exercise performed
  exerciseId String   @map("exercise_id")
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Restrict)

  // Order within the session (0-indexed)
  // Allows reordering exercises mid-workout
  orderIndex Int @map("order_index")

  // Exercise-level notes (e.g., "felt weak today", "try wider grip next time")
  notes String?

  // Relations
  sets WorkoutSet[] // Sets performed for this exercise

  // Unique constraint: each session can only have one entry per order index
  @@unique([sessionId, orderIndex])
  // Index for efficient lookup
  @@index([sessionId])
  @@index([exerciseId])
  @@map("workout_exercises")
}

// WorkoutSet model (Task 2.6)
// Represents a single set performed for an exercise in a session
// Includes weight, reps, RPE, and flags (warmup/backoff/drop/failure)
model WorkoutSet {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Parent workout exercise
  workoutExerciseId String          @map("workout_exercise_id")
  workoutExercise   WorkoutExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)

  // Set order within the exercise (0-indexed)
  setIndex Int @map("set_index")

  // Performance data
  weight Float  // Weight used (in user's preferred unit system)
  reps   Int    // Reps performed

  // Optional RPE (Rate of Perceived Exertion, 1-10 scale)
  // Used for RPE-based progression and fatigue tracking
  rpe Float? @db.DoublePrecision

  // Set flags (PRD 8.5: warmup, backoff, dropset, failure)
  // Structure: { warmup?: boolean, backoff?: boolean, dropset?: boolean, failure?: boolean }
  // Flags affect volume calculations and PR detection
  flags Json @default("{}") @map("flags")

  // Optional notes for this specific set
  notes String?

  // Unique constraint: each workout exercise can only have one set per index
  @@unique([workoutExerciseId, setIndex])
  // Index for efficient lookup
  @@index([workoutExerciseId])
  @@map("workout_sets")
}
